name: Refine Quick Ideas with AI

on:
  issues:
    types: [opened]

jobs:
  ai-refinement:
    # Only run on issues with the "idea" label
    if: contains(github.event.issue.labels.*.name, 'idea')
    runs-on: ubuntu-latest
    permissions:
      issues: write
      models: read
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Gather codebase context
        id: context
        run: |
          # Read project instructions if they exist
          if [ -f ".github/copilot-instructions.md" ]; then
            echo "Found copilot-instructions.md"
            INSTRUCTIONS=$(cat .github/copilot-instructions.md | head -c 4000)
          else
            INSTRUCTIONS=""
          fi
          
          # Read README for project overview
          if [ -f "README.md" ]; then
            README=$(cat README.md | head -c 2000)
          else
            README=""
          fi
          
          # List existing PRDs to show feature patterns
          if [ -d "prds" ]; then
            PRDS=$(ls -1 prds/ | head -20)
          else
            PRDS=""
          fi
          
          # Get directory structure (top level)
          STRUCTURE=$(find . -maxdepth 2 -type d | grep -v node_modules | grep -v .git | head -30)
          
          # Write to files to avoid escaping issues
          echo "$INSTRUCTIONS" > /tmp/instructions.txt
          echo "$README" > /tmp/readme.txt
          echo "$PRDS" > /tmp/prds.txt
          echo "$STRUCTURE" > /tmp/structure.txt

      - name: Analyze idea with AI and generate questions
        id: ai-analysis
        uses: actions/github-script@v7
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          script: |
            const fs = require('fs');
            
            const issueTitle = context.payload.issue.title;
            const issueBody = context.payload.issue.body || '';
            
            // Read codebase context
            const instructions = fs.existsSync('/tmp/instructions.txt') 
              ? fs.readFileSync('/tmp/instructions.txt', 'utf8') : '';
            const readme = fs.existsSync('/tmp/readme.txt')
              ? fs.readFileSync('/tmp/readme.txt', 'utf8') : '';
            const prds = fs.existsSync('/tmp/prds.txt')
              ? fs.readFileSync('/tmp/prds.txt', 'utf8') : '';
            const structure = fs.existsSync('/tmp/structure.txt')
              ? fs.readFileSync('/tmp/structure.txt', 'utf8') : '';
            
            const featureRequestTemplate = `
            ## Problem Statement
            <!-- What problem does this feature solve? Who experiences this problem? -->

            ## Proposed Solution
            <!-- Describe the feature you'd like to see -->

            ## User Story
            As a [type of user], I want [goal] so that [benefit].

            ## Mockup / Examples
            <!-- Screenshots, wireframes, or links to similar features in other products -->

            ## Alternatives Considered
            <!-- What other solutions have you thought about? -->

            ## Additional Context
            <!-- Any other context, links, or references -->
            `;

            const codebaseContext = `
            ## Project Context (from codebase)
            
            ### Project Overview
            ${readme || 'No README found'}
            
            ### Tech Stack & Conventions
            ${instructions || 'No copilot-instructions found'}
            
            ### Existing Feature PRDs
            ${prds || 'No PRDs found'}
            
            ### Project Structure
            ${structure || 'No structure available'}
            `;

            const prompt = `You are a helpful product manager assistant for this specific project. A user has submitted a quick idea for a software feature. Your job is to:

            1. Analyze the idea IN THE CONTEXT of this specific codebase
            2. Identify what information is missing or unclear
            3. Generate 3-5 specific, contextual follow-up questions that would help transform this into a complete feature request
            4. Consider how this idea fits with the existing tech stack and project patterns
            5. If possible, suggest a draft user story based on what you can infer

            ${codebaseContext}

            The idea should eventually be refined to match this feature request template:
            ${featureRequestTemplate}

            Here is the quick idea:
            Title: ${issueTitle}
            Description: ${issueBody}

            Respond in markdown format with:
            - A brief summary of what you understand the idea to be (1-2 sentences)
            - How this might fit into the existing project structure
            - A numbered list of specific follow-up questions (tailored to THIS idea AND this codebase)
            - A suggested draft user story if you can infer one
            - Note which sections of the feature request template still need information
            - If relevant, mention which existing files/components might be affected

            Keep your response concise and actionable.`;

            try {
              // Using GitHub Models API
              const response = await fetch('https://models.github.ai/inference/chat/completions', {
                method: 'POST',
                headers: {
                  'Authorization': `Bearer ${process.env.GITHUB_TOKEN}`,
                  'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                  model: 'openai/gpt-4o-mini',
                  messages: [
                    { role: 'system', content: 'You are a helpful product manager assistant that helps refine feature ideas with deep knowledge of the codebase.' },
                    { role: 'user', content: prompt }
                  ],
                  max_tokens: 1500,
                  temperature: 0.7,
                }),
              });

              const data = await response.json();
              
              if (data.error) {
                throw new Error(data.error.message);
              }

              const aiResponse = data.choices[0].message.content;
              core.setOutput('ai_response', aiResponse);
              
            } catch (error) {
              console.error('GitHub Models API error:', error);
              core.setOutput('ai_response', null);
              core.setOutput('error', error.message);
            }

      - name: Post AI-generated refinement questions
        uses: peter-evans/create-or-update-comment@v4
        with:
          issue-number: ${{ github.event.issue.number }}
          body: |
            ## ü§ñ AI Analysis: Let's refine this idea!

            ${{ steps.ai-analysis.outputs.ai_response }}

            ---

            <details>
            <summary>üìù Feature Request Template (copy when ready)</summary>

            ```markdown
            ## Problem Statement
            <!-- What problem does this feature solve? Who experiences this problem? -->

            ## Proposed Solution
            <!-- Describe the feature you'd like to see -->

            ## User Story
            As a __________, I want __________ so that __________.

            ## Mockup / Examples
            <!-- Screenshots, wireframes, or links to similar features -->

            ## Alternatives Considered
            <!-- What other solutions have you thought about? -->

            ## Additional Context
            <!-- Any other context, links, or references -->
            ```
            </details>

            üí° **Next steps:** Reply with answers to the questions above, then remove the `needs-refinement` label when this idea is ready to become a feature request.

      - name: Post fallback if AI fails
        if: steps.ai-analysis.outputs.error
        uses: peter-evans/create-or-update-comment@v4
        with:
          issue-number: ${{ github.event.issue.number }}
          body: |
            ## ü§ñ Let's refine this idea!

            *(AI analysis unavailable - using standard questions)*

            To help turn this into an actionable feature request, please consider:

            1. **What problem does this solve?** Who experiences this and how often?
            2. **What would success look like?** Describe the ideal end state.
            3. **Who is the target user?** Can you write a user story?
            4. **Are there examples elsewhere?** Similar features in other products?
            5. **What's the priority?** Must-have or nice-to-have?

            ---
            
            <details>
            <summary>üìù Feature Request Template</summary>

            ```markdown
            ## Problem Statement
            ## Proposed Solution  
            ## User Story
            As a __________, I want __________ so that __________.
            ## Mockup / Examples
            ## Alternatives Considered
            ## Additional Context
            ```
            </details>
